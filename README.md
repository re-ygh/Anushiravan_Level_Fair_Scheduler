## ูุฏู ฐ โ ูุฑุงุฑุฏุงุฏูุง ุฑุง ููู ฺฉู (ูุจู ุงุฒ ูุฑ ฺฉุฏ ุฌุฏ) ๐

**ูุฏู:** ุงุฒ ุฑูุฒ ุงูู ุจุฏุงูู ยซูุฑูุฏ ุฏููุงู ฺุณุช ู ุฎุฑูุฌ ุฏููุงู ฺุณุชยป.

### ูุฑุงุฑุฏุงุฏ ูุฑูุฏ (Eventูุง)

ุญุฏุงูู ุงูโูุง ุฑุง ูุดุฎุต ฺฉู:

* **ุขุง ูพุงู ูุฑูุฏ ุฏุฑ UDS ุจุฑุง ูุฑ `vtime` ุฌุฏุง ูโุขุฏ ุง ููฺฉู ุงุณุช ฺูุฏ `vtime` ุฏุฑ ฺฉ ูพุงู ุจุงุฏุ**
* **Framing ูพุงู ุฏุฑ UDS:**

  * ุงฺฏุฑ `SOCK_STREAM` ุงุณุช:

    * ูพุงูโูุง `line-delimited` ูุณุชูุฏุ (ูุฑ ุฎุท = ฺฉ JSON)
    * ุง `length-prefixed` ูุณุชูุฏุ
  * ุงฺฏุฑ `SOCK_DGRAM` ุงุณุช:

    * ูุฑ datagram ฺฉ JSON ฺฉุงูู ุงุณุช โ
* **ุงุณฺฉูุง JSON:**

  * ููุฏูุง ูุดุชุฑฺฉ: `type`, `task_id`, `vtime`, `value/payload`, ...

> ูพุดููุงุฏ: ุงุณฺฉูุง ุฏูู ุฑุง ุฏุฑ `README` ุง `docs/PROTOCOL.md` ุจููุณุ ูู ุฎูุฏุชุ ูู ุงุณุชุงุฏุ ูู ุชุณุชโฺฏุฑ ุฑุงุญุชโุชุฑ ูโููููุฏ ๐

### ูุฑุงุฑุฏุงุฏ ุฎุฑูุฌ

README ูโฺฏูุฏ ุฎุฑูุฌ ุญุฏุงูู ุงู ูุฑู ุฑุง ุจุฏู:

```json
{"vtime": 10, "schedule": ["T1", "idle", "T2"]}
```

ูพุณ ุฎุฑูุฌ ุฑุง ุงุฒ ุฑูุฒ ุงูู **line-oriented JSON** ฺุงูพ ฺฉู (ูุฑ tick ฺฉ ุฎุท) ุชุง ุชุณุชโฺฏุฑ ุฑุงุญุช ุจุฎูุงูุฏ.

---

## ูุฏู ฑ โ ุงุณฺฉูุช Build ู Targetูุง (CMake) ๐งฑ

**ูุฏู:** ุฎู ุฒูุฏ ุจุชูุงู `build && run` ฺฉูุ ุญุช ูุจู ุงุฒ ฺฉุงูู ุดุฏู scheduler.

**ูพุดููุงุฏ ุนูู:**

* ฺฉ library ุจุณุงุฒ (ูุซูุงู `alfs_core`) ุดุงูู:

  * `Task` / `RunQueue` / `Scheduler` / `Socket` / `Json`
* ฺฉ executable ุจุณุงุฒ (ูุซูุงู `alfs`) ฺฉู ููุท `CLI` ู `loop` ุฑุง ููุฏู ฺฉูุฏ.

ุงู ฺฉุงุฑ ุจุงุนุซ ูโุดูุฏ ูุฑ ุจุฎุด ุฑุง ุฌุฏุงฺฏุงูู ุชุณุช ฺฉู โ

---

## ูุฏู ฒ โ ุฌุฏูู weight ู ููููู vruntime ุฑุง ุฏูู ูพุงุฏู ฺฉู โ๏ธ

README ูโฺฏูุฏ weight ุฑุง ุงุฒ ุฌุฏูู nice ูููฺฉุณ ุจฺฏุฑ ู:

* `delta = quantum * (1024 / weight)`

ุงู ุฏููุงู ููุณู ุจุง ููุทู CFS ุงุณุช:
`nice=0` ูุฑุฌุน (`NICE_0_LOAD=1024`) ู `vruntime` ุจุง ูุฒู scale ูโุดูุฏ.

### ฺฉุงุฑ ุนูู

* ฺฉ ุขุฑุงู/ููพ ุซุงุจุช ุจุณุงุฒ: `nice [-20..19] -> weight`
* ูููููโ ููุงุฏุฑ ูุนุฑูู:

  * `nice=0` ูุฒู `1024`
  * `nice=1` ูุฒู `820`
  * ...

ุชุงุจุนโูุง:

* `weight = nice_to_weight(nice)`
* `delta_vruntime = quantum * (NICE_0_LOAD / weight)`
  (ููุน `double` ุง `fixed-point`)

> ุงฺฏุฑ ุงุณุชุงุฏ ฺฏุฑ ุฏุงุฏ ยซฺุฑุง unblock vruntime ุฑุง max ูโฺฉูุยป ูโุชูุงู ุจู `min_vruntime` ู ููุณูู placement ุงุดุงุฑู ฺฉู.

---

## ูุฏู ณ โ ูุฏู ุฏุงุฏูโูุง (Task/CPU/Cgroup) ุฑุง ููุง ฺฉู ๐งฉ

ุทุจู README ุญุฏุงูู ุงูโูุง ุฑุง ูฺฏู ุฏุงุฑ:

* `state`, `nice`, `weight`, `vruntime`, `affinity`, `cgroup_id`, `current_cpu`

**ูพุดููุงุฏ ุจุฑุง ุงูฺฉู ุจุนุฏุงู ุจู ูุดฺฉู ูุฎูุฑ:**

* `TaskState { RUNNABLE, BLOCKED, EXITED }`
* ุฏุฑ `Task` ฺฉ `bool in_runqueue` ุฏุงุดุชู ุจุงุด (ฺฉูฺฉ ูโฺฉูุฏ ุฏูุจุงุฑู push ูฺฉู)
* ฺฉ registry ูุฑฺฉุฒ:

  * `unordered_map<int, Task>` ุจุฑุง ูพุฏุง ฺฉุฑุฏู ุณุฑุน task ุจุง id

---

## ูุฏู ด โ RunQueue ูุงูุน: Min-Heap ูู ุจุง ูุงุจูุช remove ๐๏ธ

README ูโฺฏูุฏ RunQueue ฺฉ min-heap ุจุง ฺฉูุฏ `vruntime` ุงุณุช.

**ฺุงูุด:** `std::priority_queue` ุฏุฑ C++ remove ุฏูุฎูุงู ูุฏุงุฑุฏ.

ุณู ุฑุงู ุงุณุชุงูุฏุงุฑุฏ (ุจู ุชุฑุชุจ ุชูุตู):

1. **ููพ ุณูุงุฑุด (ุจูุชุฑู ู ูุงุจู ุฏูุงุน):**
   `vector<Task*> heap + unordered_map<task_id, index>`

   * `push/pop/remove` ููู `O(log n)`

2. **Lazy deletion (ุณุงุฏูโุชุฑ):**
   ููุช block/exit ุดุฏุ ฺฉ flag ุจุฒูุ ูููุน pop ุงฺฏุฑ invalid ุจูุฏ discard ฺฉู.

   * ุญูุงุณุช ุจู ุฑุดุฏ heap ุจุงุดุฏ.

3. **ุงุณุชูุงุฏู ุงุฒ `std::multiset`:**
   ุงุฒ ูุธุฑ ุฏุชุงุงุณุชุฑุงฺฉฺุฑ RBTree ูโุดูุฏุ ุงฺฏุฑ ุชฺฉูู ฺฏูุชู ยซmin-heapยปุ ููฺฉู ุงุณุช ฺฏุฑ ุจุฏููุฏ.

---

## ูุฏู ต โ min_vruntime ู max_vruntime ุฑุง ุฏุฑุณุช ูฺฏู ุฏุงุฑ ๐งญ

ุงู ุฏู ุชุง ฺฉูุฏ ุฑูุชุงุฑูุง `create/unblock/yield` ูุณุชูุฏ (README ูู ุงุณุชูุงุฏู ฺฉุฑุฏู).

* `min_vruntime`: ฺฉูฺฺฉโุชุฑู `vruntime` ุจู runnableูุง (ุนููุงู top heap)
* `max_vruntime`: ุจุฒุฑฺฏโุชุฑู `vruntime` ุจู runnableูุง
  (ุจุฑุง ูพุงุฏูโุณุงุฒ ุณุงุฏูโ `TASK_YIELD` ุนุงู ุงุณุช)

---

## ูุฏู ถ โ ุชุฑุชุจ ุงุนูุงู eventูุง (ููู ุทูุง ูพุฑูฺู) ๐ฅ

README ูโฺฏูุฏ ุฏุฑ ูุฑ `vtime` ุงู ุชุฑุชุจ:

1. receive events
2. apply events
3. schedule CPUs
4. output

ุงู ุฑุง ุฏููุงู ูููโุทูุฑ ูฺฏู ุฏุงุฑ ุชุง ยซุฒูุงูยป ูุงุท ูุดูุฏ โ

---

## ูุฏู ท โ ูพุงุฏูโุณุงุฒ eventูุงุ ูู ุจุง ูฺฉุงุช ุฑุฒู ุฏุฑุณุช ๐ง

README ุชุฑุชุจ eventูุง ุฑุง ุฏุงุฏูุ ุงูโูุง ูฺฉุงุช edge-case ูุณุชูุฏ:

### TASK_CREATE

* ุงฺฏุฑ `task_id` ุชฺฉุฑุงุฑ ุจูุฏ:

  * ุง ignore ฺฉู ุง updateุ ูู crash ูฺฉู โ๐ฅ
* `vruntime = min_vruntime` (ุทุจู README)
* `state=RUNNABLE` ู push

### TASK_BLOCK

* ุงฺฏุฑ task ุฑู CPU ุฏุฑ ุญุงู ุงุฌุฑุงุณุช:

  * `current_cpu = None` ู CPU ุขุฒุงุฏ
* ุงุฒ runqueue remove (ุง lazy invalidate)
* `state=BLOCKED`

### TASK_UNBLOCK

* `state=RUNNABLE`
* `vruntime = max(old_vruntime, min_vruntime)` (ุทุจู README)
* push

### TASK_EXIT

* ุงุฒ ููู ุฌุง ูพุงฺฉ ฺฉู: `registry + runqueue + cpu.current (ุงฺฏุฑ ุฑู CPU ุจูุฏ)`
* `state=EXITED`

### TASK_YIELD

* ุงฺฏุฑ RUNNABLE ุงุณุช:

  * `vruntime = max_vruntime` ู ุฏูุจุงุฑู push (ุทุจู README)
* ูุฏู: ุนูุจ ุจูุชุฏ โฌ

### TASK_SETNICE

* nice ุฌุฏุฏ ุฑุง clamp ฺฉู ุจู `[-20..19]`
* `weight` ุฑุง ุงุฒ ุฌุฏูู ุฏูุจุงุฑู ูุญุงุณุจู ฺฉู
* (ุงุฎุชุงุฑ) ุจุฑุง ุนุฏุงูุช:

  * ุณุงุฏู: vruntime ุฑุง ุฏุณุช ูุฒู โ
  * ูพฺุฏู: normalize ุงูุฌุงู ุจุฏู (ูุงุฒู ูุณุช)

### TASK_SET_AFFINITY

* `cpu_affinity set` ุฑุง ุขูพุฏุช ฺฉู (ุทุจู README)
* ุงฺฏุฑ task ุงูุงู ุฑู CPUุง ุงุณุช ฺฉู ุฏฺฏุฑ ูุฌุงุฒ ูุณุช:

  * ููุงู tick preemptุด ฺฉู (ุงุฒ CPU ุจุฑุฏุงุฑ ู ุจุฑฺฏุฑุฏุงู runqueue)

---

## ูุฏู ธ โ ุฎูุฏ ุงูฺฏูุฑุชู Scheduling ุฏุฑ ูุฑ tick (ฺูุฏ CPU) ๐งฎ

README ูุณุฎูโ ุณุงุฏู ุฑุง ฺฏูุชู:

* ุจุฑุง ูุฑ CPU ฺฉูฺฺฉโุชุฑู `vruntime`
* ุงฺฏุฑ affinity ูุฎูุฑุฏ ุฑุฏ ฺฉู
* ุงฺฏุฑ ูุจูุฏ idle
* ุจุนุฏ `vruntime` ุฑุง ุขูพุฏุช ฺฉู ู ุฏูุจุงุฑู push

ุงูุฌุง ูุณุฎูโ ุงุฌุฑุงโุชุฑ ฺฉู **duplicate ุฑู ฺูุฏ CPU** ูุดูุฏ:

### ุงูฺฏูุฑุชู ูพุดููุงุฏ `tick(vtime)`

* ฺฉ `vector<Task*> picked;`
* ุจุฑุง `cpu=0..N-1`:

  * ุงุฒ heap pop ฺฉู ุชุง ฺฉ task ูพุฏุง ุดูุฏ ฺฉู:

    * RUNNABLE ุจุงุดุฏ
    * affinity ุงุฌุงุฒู ุจุฏูุฏ
    * ุฑู CPU ุฏฺฏุฑ ุฏุฑ ููู tick ุงูุชุฎุงุจ ูุดุฏู ุจุงุดุฏ
  * ุงฺฏุฑ ูพุฏุง ูุดุฏ โ `schedule[cpu] = idle`
  * ุงฺฏุฑ ูพุฏุง ุดุฏ:

    * `schedule[cpu] = task_id`
    * task ุฑุง ุฏุงุฎู `picked` ูฺฏู ุฏุงุฑ (ูุนูุงู push ูฺฉู)

ุจุนุฏ ุงุฒ ุงูฺฉู ุงูุชุฎุงุจโูุง ุชูุงู ุดุฏ:

* ุจุฑุง ูุฑ task ุฏุฑ `picked`:

  * `task.vruntime += quantum * (NICE_0_LOAD / weight)`
  * push ุจู heap

ุฏุฑ ุขุฎุฑ:

* `min_vruntime` ุฑุง ุงุฒ top heap ุขูพุฏุช ฺฉู โ

---

## ูุฏู น โ preemption ุฑุง ุฏุฑุณุช ุญุณุงุจ ฺฉู โ๏ธ

README ูโฺฏูุฏ:

* ูุฑ tick ููู CPUูุง ุงุฒ ุตูุฑ schedule ุดููุฏ
* ุงฺฏุฑ `task ูุจู != ุฌุฏุฏ` โ `preemption++`

**ูฺฉุชู ุนูู:**
ุงฺฏุฑ ูุจู `idle` ุจูุฏู ู ุฌุฏุฏ task ุดุฏูุ ุงู ุฑุง preempt ุญุณุงุจ ูโฺฉู ุง ููุ

* ุจุฑุง ุณุงุฏฺฏ: **ุญุณุงุจ ูฺฉู** (ฺูู preempt ุนู ูุทุน ฺฉุงุฑู ุฏุฑุญุงู ุงุฌุฑุง)
* ูู ุงฺฏุฑ ุชุณุชโฺฏุฑ/ุงุณุชุงุฏ literal ุจุงุดุฏ: **ููุงู ุชุนุฑู README ุฑุง ุฏูู ุงุฌุฑุง ฺฉู**

---

## ูุฏู ฑฐ โ UDS: ูพุงุฏูโุณุงุฒ ููุงูู ู ุณุงุฏู ๐

README ุฏู ุฌุง ุงุดุงุฑู ฺฉุฑุฏู: ยซุณุงุฎุช UDS ู ุฏุฑุงูุช JSONยป ู ุฏุฑ ุงุณฺฉูุช main ูู ุงุฏู loop ุขูุฏู.

**ฺฉูโุฑุณฺฉโุชุฑู ุญุงูุช ูพุดููุงุฏ:**

* Unix Domain **Stream**:

  * `socket(AF_UNIX, SOCK_STREAM, 0)`
  * `bind(path)`, `listen`, `accept`
  * ุฎูุงูุฏู line-by-line (ูุฑ ุฎุท ฺฉ JSON)

ุงฺฏุฑ ุชุณุชโฺฏุฑ **datagram** ุจูุฏ:

* `SOCK_DGRAM`
* ูุฑ `recv` ฺฉ JSON

**ูฺฉุชู ุญุงุช:** ูุจู ุงุฒ `bind` ุงฺฏุฑ ูุงู socket ูุฌูุฏ ุฏุงุฑุฏ:

* `unlink(path)` ฺฉู
  ูฺฏุฑูู `bind` fail ูโุดูุฏ โ

---

## ูุฏู ฑฑ โ ุชุณุชโูุง ุณุฑุน ูู ฺฉุงู (ุจุฑุง ุงูฺฉู ฺฏุฑ ูฺฉู) โ

README ูู ยซุชุณุช ุฏุณุชยป ูพุดููุงุฏ ุฏุงุฏู. ฺฺฉโูุณุช ุญุฏุงูู:

* **ฒ ุชุณฺฉุ ฑ CPUุ nice ุจุฑุงุจุฑ**

  * ุจุงุฏ ุชูุฑุจุงู round-robin-like ุดูุฏ (vruntime ุจุฑุงุจุฑ)
* **ฒ ุชุณฺฉุ ฑ CPUุ nice ูุชูุงูุช**

  * ุขู ฺฉู nice ฺฉูุชุฑ ุฏุงุฑุฏ (ูุฒู ุจุดุชุฑ) ุจุงุฏ ุณูู ุจุดุชุฑ ุจฺฏุฑุฏ
    ฺูู vruntime ฺฉูุฏุชุฑ ุฑุดุฏ ูโฺฉูุฏ
* **block/unblock**

  * ุชุณฺฉ blocked ูุจุงุฏ schedule ุดูุฏ
  * ุจุนุฏ ุงุฒ unblock ุจุง `max(vruntime, min_vruntime)` ูุงุฑุฏ ุดูุฏ (unfair ุฌูู ููุชุฏ)
* **affinity**

  * ุชุณฺฉ ฺฉู ููุท ุฑู CPU 0 ูุฌุงุฒ ุงุณุชุ ูุจุงุฏ ุฑู CPU 1 ุจุงุฏ

---